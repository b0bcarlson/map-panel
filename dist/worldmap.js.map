{"version":3,"sources":["../src/worldmap.js"],"names":["L","CIRCLE_RADIUS","POLYGON_MAGNIFY_RATIO","WorldMap","ctrl","mapContainer","validatedMetrics","timeSeries","chartSeries","chartData","currentTargetForChart","currentParameterForChart","map","events","on","flagChartRefresh","bind","refreshChart","layerNames","layerGroup","location","parseFloat","panel","mapCenterLatitude","mapCenterLongitude","layers","getLayers","sleepNote","sleepOpacity","hoverToWake","worldCopyJump","center","zoomControl","minZoom","attributionControl","setZoom","initialZoom","panTo","control","zoom","position","addTo","addLayersToMap","id","selectedTileServer","tileServer","tileLayer","url","maxZoom","subdomains","reuseTiles","detectRetina","attribution","document","querySelector","addEventListener","event","currentTarget","value","console","debug","drawPointDetails","overlayMaps","i","length","forEach","layer","clearLayers","metrics","error","warn","Error","Object","keys","data","layerKey","markersGJ","geoJSON","markers","markerClusterGroup","objectKey","lastObjectValues","type","geoJsonName","keyArray","k","toLowerCase","newGJ","createGeoJson","latitude","longitude","newIcon","createIcon","addLayer","dataPoint","geoColor","layersColors","layersIcons","myStyle","retVal","style","JSON","parse","dataInfoWithoutGeoJson","stringify","createPopup","associateEvents","layerIcon","layerColor","icon","createMarker","createShape","dataPointExtraFields","shape","circle","rectangle","color","polygon","elementIcon","elementColor","markerProperties","AwesomeMarkers","prefix","markerColor","marker","stickyPopupInfo","bindPopup","point","stickyLabels","openPopup","closePopup","setTimeout","invalidateSize","flyTo","mapCenterMoved","legend","removeFrom","zoomFactor","parseInt","target","options","selectedPointValues","lastValueMeasure","isToRefreshChart","getTranslation","elem","created_at","currentChartData","measuresMetaInfo","measure","resp","filter","measure_"],"mappings":"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","file":"worldmap.js","sourcesContent":["/* eslint-disable id-length, no-unused-vars */\r\n\r\n/* Vendor specific */\r\nimport { defaultsDeep, isEqual } from 'lodash';\r\n\r\nimport './vendor/leaflet.awesome-markers/leaflet.awesome-markers.css!';\r\n\r\nimport * as L from './vendor/leaflet/leaflet';\r\nimport './vendor/leaflet.awesome-markers/leaflet.awesome-markers';\r\nimport './vendor/leaflet-sleep/Leaflet.Sleep';\r\nimport './vendor/leaflet.markercluster/leaflet.markercluster';\r\nimport './vendor/leaflet.markercluster/MarkerCluster.Default.css!';\r\nimport './vendor/leaflet.markercluster/MarkerCluster.css!';\r\n\r\n/* App Specific */\r\nimport { TILE_SERVERS, PLUGIN_PATH } from './definitions';\r\nimport {\r\n  dataTreatment, processData, getTimeSeries, getUpdatedChartSeries,\r\n  drawSelect, drawPopups, renderChart,\r\n  hideAllGraphPopups, getDataPointExtraFields, getDataPointStickyInfo,\r\n  getMapMarkerClassName\r\n} from './utils/map_utils';\r\n\r\nconst CIRCLE_RADIUS = 200\r\nconst POLYGON_MAGNIFY_RATIO = 3\r\n\r\nexport default class WorldMap {\r\n\r\n  constructor(ctrl, mapContainer) {\r\n    this.ctrl = ctrl;\r\n    this.mapContainer = mapContainer;\r\n    this.validatedMetrics = {};\r\n    this.timeSeries = {};\r\n    this.chartSeries = {};\r\n    this.chartData = [];\r\n    this.currentTargetForChart = null;\r\n    this.currentParameterForChart = null;\r\n    this.map = null;\r\n\r\n    this.ctrl.events.on('panel-size-changed', this.flagChartRefresh.bind(this));\r\n  }\r\n\r\n  flagChartRefresh() {\r\n    this.refreshChart = true\r\n  }\r\n  getLayers() {\r\n    return this.ctrl.layerNames.map(elem => L.layerGroup())\r\n  }\r\n\r\n  createMap() {\r\n    let location = [ parseFloat(this.ctrl.panel.mapCenterLatitude), parseFloat(this.ctrl.panel.mapCenterLongitude) ]\r\n\r\n    this.layers = this.getLayers()\r\n\r\n    this.map = L.map(this.mapContainer,\r\n      {\r\n        sleepNote: false,\r\n        sleepOpacity: .8,\r\n        hoverToWake: false,\r\n        worldCopyJump: true,\r\n        center: location,\r\n        zoomControl: false,\r\n        minZoom: 3,\r\n        attributionControl: false,\r\n        layers: this.layers\r\n      })\r\n\r\n    this.map.setZoom(this.ctrl.panel.initialZoom);\r\n    this.map.panTo(location);\r\n    L.control.zoom({position: 'topright'}).addTo(this.map);\r\n    this.addLayersToMap();\r\n\r\n    // this.map.on('zoomstart', (e) => { mapZoom = this.map.getZoom() });\r\n    this.map.on('click', () => {\r\n      hideAllGraphPopups(this.ctrl.panel.id);\r\n      this.currentTargetForChart = null;\r\n    });\r\n\r\n    const selectedTileServer = TILE_SERVERS[this.ctrl.tileServer];\r\n    L.tileLayer(selectedTileServer.url, {\r\n      maxZoom: 18,\r\n      subdomains: selectedTileServer.subdomains,\r\n      reuseTiles: true,\r\n      detectRetina: true,\r\n      attribution: selectedTileServer.attribution\r\n    }).addTo(this.map, true);\r\n\r\n    document.querySelector('#parameters_dropdown_'+this.ctrl.panel.id)\r\n      .addEventListener('change', (event) => {\r\n        this.currentParameterForChart = event.currentTarget.value;\r\n        console.debug('selecting point for measure:')\r\n        console.debug(this.currentParameterForChart)\r\n        this.drawPointDetails();\r\n      }); //, {passive: true} <= to avoid blocking\r\n  }\r\n\r\n  addLayersToMap() {\r\n    this.overlayMaps = {};\r\n    for (let i=0; i<this.ctrl.layerNames.length; i++)\r\n      this.overlayMaps[this.ctrl.layerNames[i]]=this.layers[i]\r\n    L.control.layers({}, this.overlayMaps).addTo(this.map);\r\n  }\r\n\r\n  clearLayers() {\r\n    this.layers.forEach((layer)=>layer.clearLayers())\r\n  }\r\n\r\n  /* Validate metrics for a given target*/\r\n  setMetrics() {\r\n    try {\r\n      this.validatedMetrics = this.ctrl.panel.metrics;\r\n    } catch(error) {\r\n      console.warn(error)\r\n      throw new Error('Please insert a valid JSON in the Metrics field (Edit > Tab Worldmap > Section AirQualityObserved - Metrics field)');\r\n    }\r\n  }\r\n\r\n  drawPoints() {\r\n    Object.keys(this.ctrl.data).forEach((layerKey) => {\r\n      let layer = this.ctrl.data[layerKey];\r\n      let markersGJ = L.geoJSON();\r\n      let markers = L.markerClusterGroup();\r\n\r\n      //for each layer\r\n      Object.keys(layer).forEach((objectKey) => {\r\n        let lastObjectValues = layer[objectKey][layer[objectKey].length-1];\r\n        lastObjectValues.type = layerKey;\r\n\r\n        var geoJsonName = null;\r\n        var keyArray = Object.keys(lastObjectValues);\r\n        for (var k = 0; k < keyArray.length; k++) {\r\n            if(keyArray[k].toLowerCase() === 'geojson'){\r\n                geoJsonName = keyArray[k];\r\n                break;\r\n            }\r\n        }\r\n\r\n        if(geoJsonName && lastObjectValues[geoJsonName]) {\r\n          let newGJ = this.createGeoJson(lastObjectValues, geoJsonName);\r\n          newGJ.addTo(markersGJ);\r\n        }\r\n        if (lastObjectValues.latitude && lastObjectValues.longitude) {\r\n          let newIcon = this.createIcon(lastObjectValues, geoJsonName);\r\n          try {\r\n            if(newIcon)\r\n              markers.addLayer(newIcon);\r\n          } catch(error) { console.warn(layerKey); console.warn(error); }\r\n        }\r\n      })\r\n\r\n      this.overlayMaps[layerKey].addLayer(markers);\r\n      this.overlayMaps[layerKey].addLayer(markersGJ);\r\n\r\n    });\r\n  }\r\n\r\n  createGeoJson(dataPoint, geoJsonName) {\r\n    var geoColor = this.ctrl.panel.layersColors[dataPoint.type];\r\n    if (geoColor === 'lightred') {\r\n        geoColor = '#FF9898';\r\n    } else if (geoColor === 'darkpurple') {\r\n        geoColor = '#6813B2';\r\n    } else if (geoColor === 'black') {\r\n        geoColor = '#404040';\r\n    } else if (geoColor === null && this.ctrl.panel.layersIcons[dataPoint.type] !== null) {\r\n        geoColor = 'red';\r\n    }\r\n    var myStyle = {\r\n      \"color\": geoColor,\r\n      \"weight\": 5,\r\n      \"opacity\": 0.65\r\n    };\r\n    var retVal;\r\n    if(typeof dataPoint[geoJsonName] === 'object') {\r\n        retVal = L.geoJSON(dataPoint[geoJsonName], {\r\n            style: myStyle\r\n        });\r\n    } else {\r\n        retVal = L.geoJSON(JSON.parse(dataPoint[geoJsonName]), {\r\n          style: myStyle\r\n        });\r\n    }\r\n    var dataInfoWithoutGeoJson = JSON.parse(JSON.stringify(dataPoint)); //creates clone of json\r\n    if (geoJsonName) {\r\n      delete dataInfoWithoutGeoJson[geoJsonName];\r\n    }\r\n    this.createPopup(\r\n        this.associateEvents(retVal),\r\n        getDataPointStickyInfo(dataInfoWithoutGeoJson, this.ctrl.panel.metrics)\r\n    );\r\n    return retVal;\r\n  }\r\n\r\n  createIcon(dataPoint, geoJsonName) {\r\n    //console.log(this.ctrl.panel.layersIcons)\r\n    if(!dataPoint || !dataPoint.type)\r\n      return null;\r\n\r\n    let layerIcon = this.ctrl.panel.layersIcons[dataPoint.type];\r\n    let layerColor = this.ctrl.panel.layersColors[dataPoint.type];\r\n    let icon = layerIcon ? this.createMarker(dataPoint, layerIcon, layerColor) : this.createShape(dataPoint);\r\n\r\n    var dataInfoWithoutGeoJson = JSON.parse(JSON.stringify(dataPoint)); //creates clone of json\r\n    if (geoJsonName) {\r\n        delete dataInfoWithoutGeoJson[geoJsonName];\r\n    }\r\n\r\n    this.createPopup(\r\n      this.associateEvents(icon),\r\n      getDataPointStickyInfo(dataInfoWithoutGeoJson, this.ctrl.panel.metrics)\r\n    );\r\n\r\n    return icon;\r\n  }\r\n\r\n  createShape(dataPoint) {\r\n    let dataPointExtraFields = getDataPointExtraFields(dataPoint);\r\n    let shape;\r\n\r\n    defaultsDeep(dataPointExtraFields, dataPoint)\r\n\r\n    switch(dataPoint.type) {\r\n      case 'AirQualityObserved':\r\n        shape = L.circle([dataPoint.latitude, dataPoint.longitude], CIRCLE_RADIUS, dataPointExtraFields)\r\n      break;\r\n      case 'TrafficFlowObserved':\r\n        shape = L.rectangle([\r\n            [dataPoint.latitude-(0.001*POLYGON_MAGNIFY_RATIO), dataPoint.longitude-(0.0015*POLYGON_MAGNIFY_RATIO)],\r\n            [dataPoint.latitude+(0.001*POLYGON_MAGNIFY_RATIO), dataPoint.longitude+(0.0015*POLYGON_MAGNIFY_RATIO)]\r\n          ], dataPointExtraFields)\r\n        //shape = L.circle([dataPoint.locationLatitude, dataPoint.locationLongitude], CIRCLE_RADIUS, dataPointExtraFields)\r\n      break;\r\n      default:\r\n        dataPointExtraFields.color='green'  //default color\r\n        shape = L.polygon([\r\n          [dataPoint.latitude-(0.001*POLYGON_MAGNIFY_RATIO), dataPoint.longitude-(0.0015*POLYGON_MAGNIFY_RATIO)],\r\n          [dataPoint.latitude+(0.001*POLYGON_MAGNIFY_RATIO), dataPoint.longitude],\r\n          [dataPoint.latitude-(0.001*POLYGON_MAGNIFY_RATIO), dataPoint.longitude+(0.0015*POLYGON_MAGNIFY_RATIO)],\r\n        ], dataPointExtraFields)\r\n    }\r\n\r\n    return shape;\r\n  }\r\n\r\n  createMarker(dataPoint, elementIcon, elementColor) {\r\n    let dataPointExtraFields = getDataPointExtraFields(dataPoint);\r\n    let location = [dataPoint.latitude, dataPoint.longitude];\r\n\r\n    let markerProperties = {\r\n      icon: L.AwesomeMarkers.icon(\r\n        {\r\n          icon: elementIcon,\r\n          prefix: 'fa',\r\n          markerColor: (elementColor ? elementColor : dataPointExtraFields.markerColor),\r\n          //spin: true,\r\n        }\r\n      )\r\n    }\r\n    defaultsDeep(markerProperties, dataPoint)\r\n\r\n    return L.marker(location, markerProperties);\r\n  }\r\n\r\n  associateEvents(shape) {\r\n    return shape\r\n      .on('click', (event) => {this.currentTargetForChart = event})\r\n      .on('click', () => this.drawPointDetails())\r\n  }\r\n\r\n  createPopup(shape, stickyPopupInfo) {\r\n    shape.bindPopup(stickyPopupInfo,\r\n      {\r\n        'offset': L.point(0, -2),\r\n        'className': 'worldmap-popup',\r\n        'closeButton': this.ctrl.panel.stickyLabels\r\n      }\r\n    );\r\n\r\n    if (!this.ctrl.panel.stickyLabels) {\r\n      shape.on('mouseover', function () { this.openPopup() });\r\n      shape.on('mouseout', function () { this.closePopup() });\r\n    }\r\n  }\r\n\r\n  setTarget(event) {\r\n    this.currentTargetForChart = event;\r\n  }\r\n\r\n  resize() {\r\n    setTimeout(() => {\r\n      this.map.invalidateSize();\r\n    }, 0);\r\n  }\r\n\r\n  panToMapCenter() {\r\n    let location = [parseFloat(this.ctrl.panel.mapCenterLatitude), parseFloat(this.ctrl.panel.mapCenterLongitude)]\r\n\r\n/*    if ( 'Location Variable' === this.ctrl.panel.mapCenter && this.ctrl.isADiferentCity() ) {\r\n      console.log('diferent city detected')\r\n\r\n      this.ctrl.setNewCoords()\r\n        .then(() => {\r\n          console.debug('flying to a new location')\r\n          console.debug(location)\r\n          this.map.flyTo(location)\r\n          this.ctrl.refresh();\r\n        })\r\n        .catch(error => console.warn(error))\r\n      return ;\r\n    }*/\r\n\r\n    this.map.flyTo(location);\r\n    this.ctrl.mapCenterMoved = false;\r\n  }\r\n\r\n  removeLegend() {\r\n    this.legend.removeFrom(this.map);\r\n    this.legend = null;\r\n  }\r\n\r\n  setZoom(zoomFactor) {\r\n    this.map.setZoom(parseInt(zoomFactor, 10));\r\n  }\r\n\r\n  drawPointDetails() {\r\n    console.debug('drawPointDetails');\r\n    if(this.currentTargetForChart==null){\r\n      console.debug('no point selected in map');\r\n      return ;\r\n    }\r\n\r\n    let currentParameterForChart = this.currentParameterForChart || 'value';\r\n    if (!this.currentTargetForChart.target.options.type || this.currentTargetForChart.target.options.id) {\r\n      return;\r\n    }\r\n    let selectedPointValues = this.ctrl.data[this.currentTargetForChart.target.options.type][this.currentTargetForChart.target.options.id];\r\n    if (!selectedPointValues) {\r\n        return;\r\n    }\r\n    let lastValueMeasure = selectedPointValues[selectedPointValues.length - 1];\r\n\r\n    drawSelect(this.ctrl.panel.id, lastValueMeasure, this.validatedMetrics, currentParameterForChart);\r\n\r\n    drawPopups(this.ctrl.panel.id, lastValueMeasure, this.validatedMetrics);\r\n\r\n    //refresh chart only if new values arrived\r\n    if(!this.isToRefreshChart(selectedPointValues, currentParameterForChart))\r\n      return ;\r\n\r\n    renderChart(this.ctrl.panel.id, selectedPointValues,\r\n      getTranslation(this.validatedMetrics, currentParameterForChart),\r\n      [\r\n        this.currentTargetForChart.target.options.type,\r\n        this.currentTargetForChart.target.options.id,\r\n        currentParameterForChart\r\n      ]\r\n    )\r\n\r\n    this.refreshChart = false\r\n  }\r\n\r\n\r\n  // helper method just to avoid unnecessary chart refresh\r\n  isToRefreshChart(selectedPointValues, currentParameterForChart) {\r\n    if(this.refreshChart)\r\n      return true;\r\n    let chartData = selectedPointValues.map((elem)=>[ elem.created_at, elem[currentParameterForChart] ]);\r\n    if(isEqual(this.currentChartData, chartData))\r\n      return false;\r\n    this.currentChartData = chartData\r\n    return true;\r\n  }\r\n}\r\n\r\nfunction getTranslation(measuresMetaInfo, measure) {\r\n  let resp = measuresMetaInfo.filter((measure_)=>measure_[0].toLowerCase()===measure.toLowerCase())\r\n  return resp.length>0 ? resp[0] : [measure, measure, null]\r\n}\r\n"]}