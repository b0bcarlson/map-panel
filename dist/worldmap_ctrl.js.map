{"version":3,"sources":["../src/worldmap_ctrl.js"],"names":["dataFormatter","WorldmapCtrl","$scope","$injector","contextSrv","setMapProvider","panel","mapLocationsLabels","Object","keys","iconTypes","defaultMetrics","markerColors","environmentVars","templateSrv","variables","map","elem","name","events","on","onInitEditMode","bind","onDataError","onDataReceived","onPanelTeardown","handleClickAddMetric","addMetric","handleRemoveMetric","removeMetric","metrics","push","index","splice","refresh","addEditorTab","dataList","dashboard","snapshot","locations","snapshotLocationData","console","debug","length","data","getValues","layerNames","render","error","warn","message","worldMap","remove","tileServer","user","lightTheme","saturationClass","log","navigator","geolocation","getCurrentPosition","position","coordinates","coords","recenterMap","mapCenter","setLocationByUserGeolocation","setNewCoords","mapCenterMoved","latitude","mapCenterLatitude","longitude","mapCenterLongitude","cityEnvVariable","city","then","catch","setZoom","initialZoom","showLegend","removeLegend","clearLayers","updateThresholdData","legend","update","scope","attrs","ctrl","templateUrl"],"mappings":"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","file":"worldmap_ctrl.js","sourcesContent":["/* eslint import/no-extraneous-dependencies: 0 */\r\n\r\n/* Grafana Specific */\r\nimport {MetricsPanelCtrl} from 'app/plugins/sdk';\r\nimport TimeSeries from 'app/core/time_series2';\r\nimport kbn from 'app/core/utils/kbn';\r\n/* Vendor specific */\r\nimport { defaultsDeep } from 'lodash';\r\n/* App specific */\r\nimport { PLUGIN_PATH, PANEL_DEFAULTS, DEFAULT_METRICS, MAP_LOCATIONS, ICON_TYPES, MARKER_COLORS } from './definitions'\r\nimport { getDatasources, getValidDatasources } from './utils/datasource';\r\n\r\nimport { getCityCoordinates, getSelectedCity, geolocationOptions } from './utils/map_utils';\r\n\r\nimport mapRenderer from './map_renderer';\r\nimport { DataFormatter, dataRecievedIsTheSame } from './utils/data_utils';\r\n\r\nimport './css/worldmap-panel.css!';\r\nimport './vendor/leaflet/leaflet.css!';\r\n\r\nlet dataFormatter = new DataFormatter();\r\n\r\nexport default class WorldmapCtrl extends MetricsPanelCtrl {\r\n\r\n  constructor($scope, $injector, contextSrv) {\r\n    super($scope, $injector);\r\n    this.setMapProvider(contextSrv);\r\n    defaultsDeep(this.panel, PANEL_DEFAULTS);\r\n\r\n    //helper vars definitions to be used in editor\r\n    this.mapLocationsLabels = [...Object.keys(MAP_LOCATIONS), 'Location Variable', 'Custom', 'User Geolocation'];\r\n    this.iconTypes = ICON_TYPES;\r\n    this.defaultMetrics = DEFAULT_METRICS;\r\n    this.markerColors = MARKER_COLORS;\r\n    this.environmentVars = this.templateSrv.variables.map((elem)=>elem.name)\r\n\r\n    //bind grafana events\r\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\r\n    this.events.on('data-error', this.onDataError.bind(this));\r\n    this.events.on('data-received', this.onDataReceived.bind(this));  //process resultset as a result of the execution of all queries\r\n    this.events.on('panel-teardown', this.onPanelTeardown.bind(this));\r\n    this.events.on('data-snapshot-load', this.onDataReceived.bind(this));\r\n\r\n    //bind specific editor events\r\n    this.handleClickAddMetric = this.addMetric.bind(this)\r\n    this.handleRemoveMetric = this.removeMetric.bind(this)\r\n  }\r\n\r\n  //adds a empty line in order to allow adding new metric in editor\r\n  addMetric() {\r\n    this.panel.metrics.push(['','',''])\r\n  }\r\n  //removes specific metric in editor\r\n  removeMetric(index) {\r\n    this.panel.metrics.splice(index, 1)\r\n    this.refresh();\r\n  }\r\n  //process the event of clicking the Worldmap Tab\r\n  onInitEditMode() {\r\n    this.addEditorTab('Worldmap', `${PLUGIN_PATH}partials/editor.html`, 2);\r\n  }\r\n\r\n  /* \r\n  * Process the resultset\r\n  * @dataList: The resultset from the executed query \r\n  */\r\n  onDataReceived(dataList) {\r\n    //console.debug('dataList:')\r\n    //console.debug(dataList)\r\n\r\n    if (this.dashboard.snapshot && this.locations) {\r\n      this.panel.snapshotLocationData = this.locations;\r\n    }\r\n\r\n    if (!dataList) {\r\n      console.debug('No dataList recieved but continuing...')\r\n      return ;\r\n    }\r\n    if(dataList.length===0){\r\n      console.debug('Empty dataList. returning...')\r\n      return ;\r\n    }\r\n\r\n    this.data = dataFormatter.getValues(dataList);//, this.panel.metrics);\r\n    this.layerNames = Object.keys(this.data);\r\n    this.render();\r\n  }\r\n\r\n  onDataError(error) {    \r\n    if(error && error.data && error.data.error) {\r\n      console.warn('Error: '+error.data.error.message)\r\n    }\r\n    this.onDataReceived([]);\r\n  }\r\n\r\n  onPanelTeardown() {\r\n    if (this.worldMap) {\r\n      //console.debug('Cleaning map')\r\n      this.worldMap.map.remove();\r\n    }\r\n  }\r\n\r\n  setMapProvider(contextSrv) {\r\n    this.tileServer = contextSrv.user.lightTheme ? 'CartoDB Positron' : 'CartoDB Dark';\r\n    this.saturationClass = this.tileServer === 'CartoDB Dark' ? 'map-darken' : ''; \r\n  }\r\n\r\n  setLocationByUserGeolocation(render=false) {\r\n    console.log('User Geolocation')\r\n    if (navigator.geolocation) {\r\n        navigator.geolocation.getCurrentPosition(\r\n          (position) => {\r\n            const coordinates = position.coords\r\n            this.recenterMap(coordinates);\r\n            if(render)\r\n              this.render()\r\n          },\r\n          (error) => console.log('Unable to get location!'),\r\n          geolocationOptions\r\n        );\r\n      } else {\r\n        console.log('Geolocation is not supported by this browser.');\r\n      }\r\n  }\r\n\r\n  //var watchID = navigator.geolocation.watchPosition\r\n  //navigator.geolocation.clearWatch(watchID)\r\n  setNewMapCenter() {\r\n    console.debug(this.panel.mapCenter)\r\n    if('User Geolocation'===this.panel.mapCenter) {\r\n      this.setLocationByUserGeolocation(true);\r\n    } else\r\n    if('Location Variable'===this.panel.mapCenter) {// && this.isADiferentCity()\r\n      this.setNewCoords()        \r\n    } else\r\n    if('Custom'===this.panel.mapCenter) {\r\n      this.mapCenterMoved = true;\r\n      this.render();\r\n    }\r\n    else { // center at continent or area\r\n      //console.info('centering at City/Continent location')\r\n      const coordinates = {latitude: MAP_LOCATIONS[this.panel.mapCenter].mapCenterLatitude, longitude: MAP_LOCATIONS[this.panel.mapCenter].mapCenterLongitude}\r\n      this.recenterMap(coordinates);\r\n      this.render();\r\n    }\r\n  }\r\n\r\n  isADiferentCity() {\r\n    return (getSelectedCity(this.templateSrv.variables, this.panel.cityEnvVariable)!==this.panel.city)\r\n  }\r\n\r\n  setNewCoords() {\r\n    const city = getSelectedCity(this.templateSrv.variables, this.panel.cityEnvVariable)\r\n    console.debug('selecting new city: '+city)\r\n    return getCityCoordinates(city)\r\n      .then(coordinates => {\r\n        this.panel.city = city;\r\n        if(coordinates) {          \r\n          this.recenterMap(coordinates);\r\n          this.render();\r\n        } else\r\n          console.log('Coordinates not available for the selected location '+city)\r\n      })\r\n      .catch(error => console.warn(error))\r\n  }\r\n\r\n  recenterMap(coordinates) {\r\n    console.debug('recentering at new coordinates')\r\n    //console.debug(coordinates)\r\n    this.panel.mapCenterLatitude = coordinates.latitude;\r\n    this.panel.mapCenterLongitude = coordinates.longitude;\r\n    this.mapCenterMoved = true;\r\n  }\r\n\r\n  setZoom() {\r\n    this.worldMap.setZoom(this.panel.initialZoom);\r\n  }\r\n\r\n  toggleLegend() {\r\n    if (!this.panel.showLegend) {\r\n      this.worldMap.removeLegend();\r\n    }\r\n    this.render();\r\n  }\r\n\r\n  toggleStickyLabels() {\r\n    this.worldMap.clearLayers();\r\n    this.render();\r\n  }\r\n\r\n  changeThresholds() {\r\n    this.updateThresholdData();\r\n    this.worldMap.legend.update();\r\n    this.render();\r\n  }\r\n\r\n  // eslint class-methods-use-this: 0\r\n  link(scope, elem, attrs, ctrl) {\r\n    mapRenderer(scope, elem, attrs, ctrl);\r\n  }\r\n\r\n}\r\n\r\nWorldmapCtrl.templateUrl = 'partials/module.html';\r\n"]}